#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

echo "Starting server..."

# Set default environment variables for local development
if [ -z "${DATABASE_URL:-}" ]; then
    export DATABASE_URL="postgres://tiny:password@localhost:5432/dggcrm"
    echo "Using default DATABASE_URL: ${DATABASE_URL}"
fi

if [ -z "${CREATE_SUPER_USER:-}" ]; then
    export CREATE_SUPER_USER="false"
    echo "Using default CREATE_SUPER_USER: ${CREATE_SUPER_USER}"
fi

if [ -z "${INSERT_FAKE_DATA:-}" ]; then
    export INSERT_FAKE_DATA="false"
    echo "Using default INSERT_FAKE_DATA: ${INSERT_FAKE_DATA}"
fi

# Run migrations before starting server
python manage.py migrate

# Optionaly create super user
if [ "${CREATE_SUPER_USER}" = "1" ] || [ "${CREATE_SUPER_USER}" = "true" ]; then
    echo "Creating testing super user..."

    # Allow overrides in docker-compose
    export DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:=admin}
    export DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:=admin@example.com}
    export DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:=admin}

    if ! python manage.py createsuperuser --noinput --skip-checks; then
        echo "Superuser creation failed (likely already exists). Continuing..."
    fi
    python fake/create_users.py
else
    echo "Skipping super user..."
fi

# Optionaly fill DB with fake data
if [ "${INSERT_FAKE_DATA}" = "1" ] || [ "${INSERT_FAKE_DATA}" = "true" ]; then
    python fake/main.py "${DATABASE_URL}"
fi
exec python manage.py runserver 0.0.0.0:8080
